name: Weekly Deep Code Analysis

on:
  schedule:
    - cron: '0 2 * * 0'  # Every Sunday at 2 AM UTC
  workflow_dispatch:
    inputs:
      target-dir:
        description: 'Directory to analyze'
        required: false
        default: 'storage/'
      depth:
        description: 'Search depth for RLM'
        required: false
        default: '5'

permissions:
  contents: write
  issues: write

jobs:
  deep-analysis:
    name: Navigate Codebase with Ariadne RLM
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set analysis target
        id: target
        run: |
          TARGET="${{ github.event.inputs.target-dir || 'storage/' }}"
          DEPTH="${{ github.event.inputs.depth || '5' }}"
          echo "dir=$TARGET" >> $GITHUB_OUTPUT
          echo "depth=$DEPTH" >> $GITHUB_OUTPUT

      - name: Navigate with Ariadne RLM
        id: analysis
        uses: richinex/ariadne-action@v1
        with:
          task: |
            Perform a comprehensive analysis of the ${{ steps.target.outputs.dir }} directory.

            Analyze:
            1. Code architecture and design patterns
            2. Potential optimizations and refactoring opportunities
            3. Error handling patterns
            4. Concurrency and race condition risks
            5. Database query efficiency
            6. Memory usage and potential leaks
            7. Code duplication and abstraction opportunities

            Provide specific recommendations with file:line references.
          command: rlm
          provider: deepseek
          api-key: ${{ secrets.DEEPSEEK_API_KEY }}
          depth: ${{ steps.target.outputs.depth }}
          timeout: 600  # 10 minutes
          max-iterations: 30
          verbose: true

      - name: Save analysis report
        run: |
          mkdir -p reports
          cat > reports/analysis-$(date +%Y-%m-%d).md << 'EOF'
          # Code Analysis Report
          **Date**: $(date +%Y-%m-%d)
          **Target**: ${{ steps.target.outputs.dir }}
          **Depth**: ${{ steps.target.outputs.depth }}

          ## Analysis Results

          ${{ steps.analysis.outputs.result }}

          ---
          *Generated by Ariadne RLM - Following the thread through your codebase*
          EOF

      - name: Create analysis issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('reports/analysis-' + new Date().toISOString().split('T')[0] + '.md', 'utf8');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ“Š Weekly Code Analysis - ${new Date().toISOString().split('T')[0]}`,
              body: report,
              labels: ['analysis', 'automated', 'rlm']
            });

      - name: Commit report
        run: |
          git config user.name "Ariadne Bot"
          git config user.email "ariadne@github.actions"
          git add reports/
          git commit -m "chore: Add weekly code analysis report" || exit 0
          git push

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: analysis-report
          path: reports/
          retention-days: 90
